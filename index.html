<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ImmoAgent ‚Äî German Real Estate Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"DM Sans","SF Pro Text",sans-serif;font-size:14px;background:#f2f2f7;color:#1d1d1f;-webkit-font-smoothing:antialiased;}
:root{
  --bg:#f2f2f7;--surface:#ffffff;--s2:#f5f5f7;
  --border:rgba(0,0,0,0.08);--border2:rgba(0,0,0,0.13);
  --text:#1d1d1f;--t2:#6e6e73;--t3:#aeaeb2;
  --blue:#0071e3;--blue2:#0057b8;
  --green:#34c759;--orange:#ff9500;--red:#ff3b30;
  --r:10px;--card-r:16px;--sw:360px;--hh:52px;
}
/* ‚îÄ‚îÄ Shell ‚îÄ‚îÄ */
#shell{display:grid;grid-template-rows:var(--hh) 1fr;grid-template-columns:var(--sw) 1fr;height:100vh;width:100vw;}
/* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
#topbar{grid-column:1/-1;display:flex;align-items:center;padding:0 20px;background:rgba(255,255,255,0.88);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border-bottom:1px solid var(--border);gap:14px;z-index:100;}
.brand{display:flex;align-items:center;gap:8px;}
.brand-icon{width:28px;height:28px;background:var(--blue);border-radius:7px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;flex-shrink:0;}
.brand-name{font-size:15px;font-weight:600;letter-spacing:-.3px;}
.brand-name span{color:var(--blue);}
.sep{flex:1;}
.tb-chip{display:flex;align-items:center;gap:6px;padding:5px 12px;background:var(--s2);border-radius:20px;font-size:12px;font-weight:500;color:var(--t2);cursor:pointer;border:none;font-family:inherit;transition:background .15s;}
.tb-chip:hover{background:#e5e5ea;}
.tb-chip .dot{width:7px;height:7px;border-radius:50%;background:var(--green);}
.tb-chip .dot.or{background:var(--orange);}
.tb-chip .dot.gr{background:var(--t3);}
#settingsBtn{width:32px;height:32px;border-radius:50%;background:var(--s2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--t2);font-size:15px;transition:background .15s;}
#settingsBtn:hover{background:#e5e5ea;}
/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
#sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
#sidebar::-webkit-scrollbar{width:4px;}
#sidebar::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}
.sb-head{padding:20px 20px 0;}
.sb-title{font-size:20px;font-weight:700;letter-spacing:-.5px;}
.sb-sub{font-size:12px;color:var(--t2);margin-top:3px;line-height:1.4;}
.fsec{padding:16px 20px 4px;}
.flabel{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:10px;}
.fgroup{background:var(--s2);border-radius:var(--r);overflow:hidden;}
.frow{display:flex;align-items:center;padding:10px 14px;gap:10px;border-bottom:1px solid var(--border);transition:background .1s;}
.frow:last-child{border-bottom:none;}
.frow:focus-within{background:rgba(0,113,227,.04);}
.frow.tw{gap:0;}
.fhalf{flex:1;display:flex;align-items:center;gap:8px;}
.fhalf+.fhalf{border-left:1px solid var(--border);padding-left:12px;}
.flb{font-size:12.5px;color:var(--t2);flex-shrink:0;white-space:nowrap;}
.fsp{flex:1;}
.finp{background:none;border:none;outline:none;font-family:"DM Mono",monospace;font-size:13px;font-weight:500;color:var(--text);text-align:right;width:80px;}
.finp::-webkit-inner-spin-button,.finp::-webkit-outer-spin-button{-webkit-appearance:none;}
.funit{font-size:11.5px;color:var(--t3);font-family:"DM Mono",monospace;flex-shrink:0;}
.fsel{background:none;border:none;outline:none;font-family:inherit;font-size:13px;font-weight:500;color:var(--text);cursor:pointer;-webkit-appearance:none;appearance:none;max-width:160px;text-align:right;}
.seg{display:flex;background:var(--s2);border-radius:var(--r);padding:3px;gap:2px;}
.seg input[type=radio]{display:none;}
.seg label{flex:1;text-align:center;font-size:12px;font-weight:500;color:var(--t2);padding:5px 2px;border-radius:8px;cursor:pointer;transition:all .18s;user-select:none;}
.seg input[type=radio]:checked+label{background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.12);}
.btn-go{display:flex;align-items:center;justify-content:center;gap:8px;width:calc(100% - 40px);margin:16px 20px 20px;padding:13px 20px;background:var(--blue);color:#fff;border:none;border-radius:var(--r);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:background .15s,transform .1s;letter-spacing:-.1px;}
.btn-go:hover{background:var(--blue2);}
.btn-go:active{transform:scale(.98);}
.mbadge{margin-left:auto;font-size:11px;font-weight:500;opacity:.7;font-family:"DM Mono",monospace;}
/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
#main{overflow-y:auto;overflow-x:hidden;background:var(--bg);position:relative;}
#emptyState{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;padding:40px;text-align:center;}
.ei{width:64px;height:64px;background:var(--surface);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 2px 16px rgba(0,0,0,.06);margin-bottom:4px;}
.et{font-size:18px;font-weight:700;letter-spacing:-.4px;}
.ed{font-size:13px;color:var(--t2);max-width:280px;line-height:1.5;}
.chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:4px;}
.chip{padding:4px 10px;background:var(--surface);border-radius:20px;font-size:11px;font-weight:500;color:var(--t2);border:1px solid var(--border);}
/* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
#resultsContent{display:none;}
/* Tabs */
.tabs{display:flex;padding:0 20px;background:rgba(242,242,247,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;}
.tab{padding:12px 16px;background:none;border:none;font-family:inherit;font-size:13px;font-weight:500;color:var(--t2);cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;white-space:nowrap;}
.tab.on{color:var(--blue);border-bottom-color:var(--blue);font-weight:600;}
.tab:hover:not(.on){color:var(--text);}
/* Tab panels */
.tpanel{padding:20px;display:none;}
.tpanel.on{display:block;}
/* Score hero */
.hero{background:var(--surface);border-radius:var(--card-r);padding:24px;display:flex;align-items:flex-start;gap:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.ring-wrap{position:relative;width:80px;height:80px;flex-shrink:0;}
.ring-wrap svg{transform:rotate(-90deg);}
.ring-track{fill:none;stroke:var(--s2);stroke-width:6;}
.ring-fill{fill:none;stroke:var(--blue);stroke-width:6;stroke-linecap:round;stroke-dasharray:220;stroke-dashoffset:220;transition:stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1),stroke .3s;}
.ring-num{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:20px;font-weight:700;letter-spacing:-1px;color:var(--text);line-height:1;}
.ring-num small{font-size:10px;font-weight:400;color:var(--t3);letter-spacing:0;}
.hero-body{flex:1;min-width:0;}
.vey{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);margin-bottom:4px;}
.vt{font-size:22px;font-weight:700;letter-spacing:-.6px;margin-bottom:8px;}
.vt.g{color:#1a7f3c;}.vt.o{color:#c15200;}.vt.r{color:var(--red);}
.vs{font-size:13px;color:var(--t2);line-height:1.55;}
/* Metrics */
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
.mc{background:var(--surface);border-radius:var(--card-r);padding:14px 16px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.mv{font-size:20px;font-weight:700;letter-spacing:-.6px;font-family:"DM Mono",monospace;margin-bottom:2px;}
.mv.ok{color:#1a7f3c;}.mv.mid{color:#c15200;}.mv.bad{color:var(--red);}
.ml{font-size:11px;font-weight:500;color:var(--t3);letter-spacing:.1px;}
.mb{font-size:10.5px;color:var(--t3);margin-top:4px;font-family:"DM Mono",monospace;}
/* Two col */
.twoc{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
/* Card */
.card{background:var(--surface);border-radius:var(--card-r);box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:hidden;margin-bottom:12px;}
.card:last-child{margin-bottom:0;}
.ch{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid var(--border);}
.ct{font-size:13px;font-weight:600;letter-spacing:-.2px;}
.ctag{font-size:11px;font-weight:500;padding:3px 8px;border-radius:6px;background:var(--s2);color:var(--t2);}
.ctag.g{background:#d1fadf;color:#1a7f3c;}
.cb{padding:14px 16px;}
/* Bar chart */
.bw{display:flex;align-items:flex-end;gap:8px;height:80px;}
.bc{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;}
.bv{font-size:9.5px;font-family:"DM Mono",monospace;color:var(--t2);text-align:center;}
.bb{width:100%;border-radius:4px 4px 0 0;min-height:4px;transition:height .6s cubic-bezier(.4,0,.2,1);}
.bb.p{background:var(--green);}.bb.n{background:var(--red);}
.byr{font-size:9px;color:var(--t3);font-family:"DM Mono",monospace;}
/* Flags */
.flist{display:flex;flex-direction:column;gap:8px;padding:12px 16px;}
.fi{display:flex;align-items:flex-start;gap:8px;font-size:12px;color:var(--t2);line-height:1.4;}
.fd{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.fd.ok{background:var(--green);}.fd.warn{background:var(--orange);}.fd.bad{background:var(--red);}.fd.info{background:var(--blue);}
/* Table */
.dt{width:100%;border-collapse:collapse;font-size:12px;}
.dt th{text-align:left;padding:10px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s2);border-bottom:1px solid var(--border);}
.dt td{padding:9px 16px;color:var(--text);border-bottom:1px solid var(--border);font-family:"DM Mono",monospace;font-size:12px;}
.dt tr:last-child td{border-bottom:none;}
.dt tr.hl{background:rgba(0,113,227,.04);}
.dt td.pos{color:#1a7f3c;}.dt td.neg{color:var(--red);}
.note{padding:10px 16px;font-size:11px;color:var(--t3);}
/* AI text */
.aitext{font-size:14px;line-height:1.7;color:var(--text);white-space:pre-wrap;padding:20px;font-family:-apple-system,BlinkMacSystemFont,"DM Sans",sans-serif;}
/* Market grid */
.mgrd{display:grid;grid-template-columns:1fr 1fr;}
.mc2{padding:16px 18px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);}
.mc2:nth-child(2n){border-right:none;}
.mc2:nth-last-child(-n+2){border-bottom:none;}
.mk{font-size:11px;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:500;}
.mv2{font-size:17px;font-weight:700;font-family:"DM Mono",monospace;letter-spacing:-.5px;}
.ms{font-size:10.5px;color:var(--t3);margin-top:2px;}
/* Loading */
#loadingOverlay{display:none;position:absolute;inset:0;background:rgba(242,242,247,.88);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);align-items:center;justify-content:center;z-index:50;}
#loadingOverlay.on{display:flex;}
.lcard{background:var(--surface);border-radius:20px;padding:28px 32px;min-width:320px;box-shadow:0 8px 40px rgba(0,0,0,.12);text-align:center;}
.ltitle{font-size:16px;font-weight:700;margin-bottom:6px;letter-spacing:-.3px;}
.lstep{font-size:13px;color:var(--t2);margin-bottom:18px;min-height:20px;}
.ltrack{height:4px;background:var(--s2);border-radius:4px;overflow:hidden;}
.lfill{height:4px;background:var(--blue);border-radius:4px;width:0;transition:width 6s cubic-bezier(.4,0,.2,1);}
.ldots{display:flex;gap:6px;justify-content:center;margin-top:16px;}
.ldot{width:7px;height:7px;border-radius:50%;background:var(--border2);transition:background .3s;}
.ldot.on{background:var(--blue);}
/* ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ */
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);z-index:200;align-items:center;justify-content:center;}
.backdrop.on{display:flex;}
.modal{background:var(--surface);border-radius:20px;width:480px;max-width:calc(100vw - 40px);box-shadow:0 24px 60px rgba(0,0,0,.22);overflow:hidden;animation:min .22s cubic-bezier(.4,0,.2,1);}
@keyframes min{from{opacity:0;transform:scale(.95) translateY(8px);}to{opacity:1;transform:none;}}
.mh{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1px solid var(--border);}
.mhttl{font-size:17px;font-weight:700;letter-spacing:-.4px;}
.mclose{width:28px;height:28px;border-radius:50%;background:var(--s2);border:none;cursor:pointer;font-size:13px;color:var(--t2);display:flex;align-items:center;justify-content:center;}
.mbody{padding:20px 24px;}
.mseclabel{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:10px;}
.mopt{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--r);cursor:pointer;transition:background .12s;margin-bottom:4px;border:2px solid transparent;}
.mopt:hover{background:var(--s2);}
.mopt.sel{background:rgba(0,113,227,.06);border-color:rgba(0,113,227,.3);}
.micon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;background:var(--s2);}
.minfo{flex:1;}
.mname{font-size:14px;font-weight:600;}
.mdesc{font-size:12px;color:var(--t2);margin-top:1px;}
.mradio{width:18px;height:18px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:border-color .15s;}
.mradio.on{border-color:var(--blue);}
.mradio.on::after{content:'';width:8px;height:8px;border-radius:50%;background:var(--blue);}
.minpgrp{margin-top:12px;}
.minprow{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--s2);border-radius:var(--r);margin-bottom:6px;}
.minprow label{font-size:12.5px;color:var(--t2);flex-shrink:0;width:100px;}
.minprow input,.minprow select{flex:1;background:none;border:none;outline:none;font-size:13px;font-family:"DM Mono",monospace;color:var(--text);font-weight:500;}
.mfoot{padding:16px 24px 20px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border);}
.btp{padding:9px 20px;background:var(--blue);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s;}
.btp:hover{background:var(--blue2);}
.bts{padding:9px 20px;background:var(--s2);color:var(--text);border:none;border-radius:8px;font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;}
/* Responsive */
@media(max-width:900px){:root{--sw:300px;}.mgrid{grid-template-columns:repeat(2,1fr);}.twoc{grid-template-columns:1fr;}}
@media(max-width:660px){#shell{grid-template-columns:1fr;grid-template-rows:var(--hh) 45vh 1fr;}#sidebar{grid-row:2;}#main{grid-row:3;}.mgrid{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<div id="shell">

<!-- TOP BAR -->
<header id="topbar">
  <div class="brand"><div class="brand-icon">üè†</div><div class="brand-name">Immo<span>Agent</span></div></div>
  <div class="sep"></div>
  <button class="tb-chip" id="modelChip" onclick="openSettings()">
    <span class="dot gr" id="modelDot"></span>
    <span id="chipLabel">Configure AI</span>
  </button>
  <button id="settingsBtn" onclick="openSettings()">‚öô</button>
</header>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="sb-head"><div class="sb-title">Property Analysis</div><div class="sb-sub">German real estate ¬∑ AfA ¬∑ IRR ¬∑ 20-yr projection</div></div>

  <div class="fsec"><div class="flabel">Property</div>
    <div class="fgroup">
      <div class="frow"><span class="flb">Address</span><span class="fsp"></span><input id="f_address" class="finp" type="text" value="Sch√∂nhauser Allee 36, 10435 Berlin" style="width:160px;text-align:right;font-family:inherit;font-size:12px;"></div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Area</span><span class="fsp"></span><input id="f_sqm" class="finp" type="number" value="78"><span class="funit">m¬≤</span></div>
        <div class="fhalf"><span class="flb">Built</span><span class="fsp"></span><input id="f_yearbuilt" class="finp" type="number" value="1992" style="width:55px;"></div>
      </div>
      <div class="frow"><span class="flb">Condition</span><span class="fsp"></span>
        <select id="f_condition" class="fsel">
          <option value="existing">Existing building</option>
          <option value="existing">Partially renovated</option>
          <option value="newbuild">New build (3% AfA)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="fsec"><div class="flabel">Financing</div>
    <div class="fgroup">
      <div class="frow"><span class="flb">Purchase price</span><span class="fsp"></span><input id="f_price" class="finp" type="number" value="420000"><span class="funit">‚Ç¨</span></div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Equity</span><span class="fsp"></span><input id="f_equity" class="finp" type="number" value="100000"><span class="funit">‚Ç¨</span></div>
        <div class="fhalf"><span class="flb">Interest</span><span class="fsp"></span><input id="f_interest" class="finp" type="number" value="3.8" step="0.1" style="width:40px;"><span class="funit">%</span></div>
      </div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Repayment</span><span class="fsp"></span><input id="f_repayment" class="finp" type="number" value="2.0" step="0.1" style="width:40px;"><span class="funit">%</span></div>
        <div class="fhalf"><span class="flb">GrESt</span><span class="fsp"></span><input id="f_grunderwerb" class="finp" type="number" value="6.0" step="0.5" style="width:40px;"><span class="funit">%</span></div>
      </div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Notary</span><span class="fsp"></span><input id="f_notary" class="finp" type="number" value="2.0" step="0.1" style="width:40px;"><span class="funit">%</span></div>
        <div class="fhalf"><span class="flb">Land share</span><span class="fsp"></span><input id="f_landshare" class="finp" type="number" value="20" step="5" style="width:40px;"><span class="funit">%</span></div>
      </div>
    </div>
  </div>

  <div class="fsec"><div class="flabel">Income & Costs</div>
    <div class="fgroup">
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Cold rent</span><span class="fsp"></span><input id="f_rent" class="finp" type="number" value="1420"><span class="funit">‚Ç¨</span></div>
        <div class="fhalf"><span class="flb">Hausgeld</span><span class="fsp"></span><input id="f_hausgeld" class="finp" type="number" value="200"><span class="funit">‚Ç¨</span></div>
      </div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Maintenance</span><span class="fsp"></span><input id="f_maintenance" class="finp" type="number" value="1200"><span class="funit">‚Ç¨</span></div>
        <div class="fhalf"><span class="flb">Management</span><span class="fsp"></span><input id="f_management" class="finp" type="number" value="600"><span class="funit">‚Ç¨</span></div>
      </div>
    </div>
  </div>

  <div class="fsec"><div class="flabel">Assumptions</div>
    <div class="fgroup">
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Rent growth</span><span class="fsp"></span><input id="f_rentgrowth" class="finp" type="number" value="2.0" step="0.1" style="width:40px;"><span class="funit">%</span></div>
        <div class="fhalf"><span class="flb">Appreciation</span><span class="fsp"></span><input id="f_appreciation" class="finp" type="number" value="2.0" step="0.1" style="width:40px;"><span class="funit">%</span></div>
      </div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">Tax rate</span><span class="fsp"></span><input id="f_taxrate" class="finp" type="number" value="44" step="1" style="width:40px;"><span class="funit">%</span></div>
        <div class="fhalf"><span class="flb">Horizon</span><span class="fsp"></span><input id="f_horizon" class="finp" type="number" value="10" style="width:40px;"><span class="funit">yr</span></div>
      </div>
      <div class="frow tw">
        <div class="fhalf"><span class="flb">AfA method</span><span class="fsp"></span>
          <select id="f_afa_method" class="fsel">
            <option value="linear" selected>Linear</option>
            <option value="degressive">Degressive</option>
          </select>
        </div>
        <div class="fhalf"><span class="flb">AfA rate</span><span class="fsp"></span><input id="f_afa_rate" class="finp" type="number" min="0" max="0.07" step="0.001" placeholder="default" style="width:58px;"><span class="funit">0‚Äì0.07</span></div>
      </div>
      <div class="frow" style="flex-direction:column;align-items:stretch;gap:8px;">
        <span class="flb">Vacancy</span>
        <div class="seg">
          <input type="radio" name="vac" id="v1" checked><label for="v1">1%</label>
          <input type="radio" name="vac" id="v3"><label for="v3">3%</label>
          <input type="radio" name="vac" id="v5"><label for="v5">5%</label>
          <input type="radio" name="vac" id="v8"><label for="v8">8%</label>
        </div>
      </div>
    </div>
  </div>

  <button class="btn-go" onclick="runAnalysis()">
    Analyse Now
    <span class="mbadge" id="btnBadge">Instant</span>
  </button>
</aside>

<!-- MAIN -->
<main id="main">
  <div id="emptyState">
    <div class="ei">üè†</div>
    <div class="et">Ready to Analyse</div>
    <div class="ed">Fill in the property details, then click Analyse. Get AfA tax savings, IRR projections, and optional AI commentary.</div>
    <div class="chips">
      <span class="chip">AfA ¬ß7 EStG</span><span class="chip">IRR 10/15/20yr</span>
      <span class="chip">Bodenrichtwert</span><span class="chip">Mietspiegel</span>
      <span class="chip">Instant ¬∑ AI Analysis ¬∑ AI Analysis Lite ¬∑ Private AI</span>
    </div>
  </div>

  <div id="resultsContent">
    <div class="tabs">
      <button class="tab on" onclick="sw(this,'ov')">Overview</button>
      <button class="tab" onclick="sw(this,'pr')">Projections</button>
      <button class="tab" onclick="sw(this,'ai')">AI Analysis</button>
      <button class="tab" onclick="sw(this,'mk')">Market Data</button>
    </div>

    <!-- OVERVIEW -->
    <div class="tpanel on" id="tp-ov">
      <div class="hero">
        <div class="ring-wrap">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle class="ring-track" cx="40" cy="40" r="34"/>
            <circle class="ring-fill" cx="40" cy="40" r="34" id="scoreArc"/>
          </svg>
          <div class="ring-num" id="scoreNum">‚Äî<small>/10</small></div>
        </div>
        <div class="hero-body">
          <div class="vey">Investment Verdict</div>
          <div class="vt" id="verdictTitle">‚Äî</div>
          <div class="vs" id="verdictSummary"></div>
        </div>
      </div>

      <div class="mgrid">
        <div class="mc"><div class="mv" id="mv_ny">‚Äî</div><div class="ml">Net Rental Yield</div><div class="mb">Benchmark 3.2%</div></div>
        <div class="mc"><div class="mv" id="mv_kpf">‚Äî</div><div class="ml">Kaufpreisfaktor</div><div class="mb">Target &lt;25√ó</div></div>
        <div class="mc"><div class="mv" id="mv_irr">‚Äî</div><div class="ml">IRR 10 yr</div><div class="mb">Target &gt;5%</div></div>
        <div class="mc"><div class="mv" id="mv_cf">‚Äî</div><div class="ml">Cash Flow/Mo Yr1</div><div class="mb">After tax &amp; debt</div></div>
        <div class="mc"><div class="mv" id="mv_ltv">‚Äî</div><div class="ml">Loan-to-Value</div><div class="mb">Bank limit 80%</div></div>
        <div class="mc"><div class="mv" id="mv_afa">‚Äî</div><div class="ml">AfA Tax Saving/yr</div><div class="mb" id="mb_afa">‚Äî</div></div>
        <div class="mc"><div class="mv" id="mv_ann">‚Äî</div><div class="ml">Monthly Annuity</div><div class="mb">Principal+interest</div></div>
        <div class="mc"><div class="mv" id="mv_nk">‚Äî</div><div class="ml">Closing Costs</div><div class="mb" id="mb_nk">‚Äî</div></div>
      </div>

      <div class="twoc">
        <div class="card">
          <div class="ch"><span class="ct">Annual Cash Flow</span><span class="ctag">Base Case</span></div>
          <div class="cb"><div class="bw" id="barChart"></div></div>
        </div>
        <div class="card">
          <div class="ch"><span class="ct">Investment Flags</span></div>
          <div class="flist" id="flagsList"></div>
        </div>
      </div>
    </div>

    <!-- PROJECTIONS -->
    <div class="tpanel" id="tp-pr">
      <div class="card">
        <div class="ch"><span class="ct">Returns at Exit Horizons</span><span class="ctag">IRR &amp; Equity Multiple</span></div>
        <table class="dt"><thead><tr><th>Horizon</th><th>IRR</th><th>Equity Multiple</th><th>Net Gain on Equity</th></tr></thead><tbody id="irrTable"></tbody></table>
      </div>
      <div class="card">
        <div class="ch"><span class="ct">Year-by-Year Overview</span><span class="ctag">Base Case</span></div>
        <table class="dt">
          <thead><tr><th>Year</th><th>Gross Rent</th><th>Interest</th><th>AfA</th><th>Tax Impact</th><th>Cash Flow</th><th>Property Value</th></tr></thead>
          <tbody id="detailTable"></tbody>
        </table>
        <div class="note">üìå Positive tax impact = refund (Werbungskosten√ºberschuss). AfA basis excludes land share.</div>
      </div>
    </div>

    <!-- AI ANALYSIS -->
    <div class="tpanel" id="tp-ai">
      <div class="card">
        <div class="ch"><span class="ct">Expert Analysis</span><span class="ctag" id="aiBadge">‚Äî</span></div>
        <div class="aitext" id="aiText">No analysis mode configured. Click ‚öô Settings to add your connection details.</div>
      </div>
    </div>

    <!-- MARKET DATA -->
    <div class="tpanel" id="tp-mk">
      <div class="card" style="margin-bottom:12px;">
        <div class="ch"><span class="ct">Live Market Data</span><span class="ctag" id="mktBadge">‚Äî</span></div>
        <div class="mgrd" id="mktGrid"></div>
      </div>
      <div class="card">
        <div class="ch"><span class="ct">AfA Depreciation Summary</span></div>
        <table class="dt"><thead><tr><th>Parameter</th><th>Value</th><th>Note</th></tr></thead><tbody id="afaBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingOverlay">
    <div class="lcard">
      <div class="ltitle">Analysing‚Ä¶</div>
      <div class="lstep" id="lstep">Starting‚Ä¶</div>
      <div class="ltrack"><div class="lfill" id="lfill"></div></div>
      <div class="ldots" id="ldots">
        <div class="ldot"></div><div class="ldot"></div><div class="ldot"></div>
        <div class="ldot"></div><div class="ldot"></div><div class="ldot"></div>
      </div>
    </div>
  </div>
</main>
</div>

<!-- SETTINGS MODAL -->
<div class="backdrop" id="backdrop" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <div class="mh"><span class="mhttl">AI Model Settings</span><button class="mclose" onclick="closeSettings()">‚úï</button></div>
    <div class="mbody">
      <div class="mseclabel">Choose Analysis Mode</div>
      <div class="mopt" id="opt_local"  onclick="selModel('local')"><div class="micon">üíª</div><div class="minfo"><div class="mname">Instant</div><div class="mdesc">Calculations only ¬∑ No AI mode</div></div><div class="mradio" id="r_local"></div></div>
      <div class="mopt" id="opt_claude" onclick="selModel('claude')"><div class="micon">ü§ñ</div><div class="minfo"><div class="mname">AI Analysis Expert Mode</div><div class="mdesc">Enhanced quality analysis</div></div><div class="mradio" id="r_claude"></div></div>
      <div class="mopt" id="opt_openai" onclick="selModel('openai')"><div class="micon">‚ö°</div><div class="minfo"><div class="mname">AI Analysis Lite</div><div class="mdesc">Faster analysis response</div></div><div class="mradio" id="r_openai"></div></div>
      <div class="mopt" id="opt_ollama" onclick="selModel('ollama')"><div class="micon">üß†</div><div class="minfo"><div class="mname">Private AI</div><div class="mdesc">Run analysis with your own setup</div></div><div class="mradio" id="r_ollama"></div></div>

      <div class="minpgrp" id="inp_claude" style="display:none">
        <div class="minprow"><label>API Key</label><input id="claude_key" type="password" placeholder="sk-live-‚Ä¶"></div>
        <div class="minprow"><label>Backend URL</label><input id="backend_url" type="text" placeholder="https://your-app.railway.app (optional)"></div>
      </div>
      <div class="minpgrp" id="inp_openai" style="display:none">
        <div class="minprow"><label>API Key</label><input id="openai_key" type="password" placeholder="sk-‚Ä¶"></div>
        <div class="minprow"><label>Profile</label><select id="openai_model"><option value="standard">Standard</option><option value="fast">Fast</option><option value="legacy">Legacy</option></select></div>
      </div>
      <div class="minpgrp" id="inp_ollama" style="display:none">
        <div class="minprow"><label>Connection URL</label><input id="ollama_url" type="text" placeholder="http://localhost:11434" value="http://localhost:11434"></div>
        <div class="minprow"><label>Configuration name</label><input id="ollama_model" type="text" placeholder="private-analysis" value="private-analysis"></div>
        <div style="font-size:11.5px;color:var(--t2);margin-top:8px;line-height:1.6;padding:0 2px;">
          üí° Ensure your local service is running before clicking Analyse.
        </div>
      </div>
    </div>
    <div class="mfoot">
      <button class="bts" onclick="closeSettings()">Cancel</button>
      <button class="btp" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CFGK = 'immoagent_v3';
const DEFAULTS = {
  model: 'claude',
  backend_url: 'https://web-production-61c120.up.railway.app'
};

let cfg = (() => {
  try {
    return Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem(CFGK)) || {});
  } catch {
    return { ...DEFAULTS };
  }
})();

// normalize so an old saved empty string can't break it
cfg.backend_url = (cfg.backend_url || DEFAULTS.backend_url).replace(/\/$/, '');

let selMdl = cfg.model || 'local';
  
function openSettings() {
  cfg = (() => { try { return JSON.parse(localStorage.getItem(CFGK))||{}; } catch { return {}; }})();
  selMdl = cfg.model||'local';
  if (cfg.claude_key)   document.getElementById('claude_key').value   = cfg.claude_key;
  if (cfg.backend_url)  document.getElementById('backend_url').value  = cfg.backend_url;
  if (cfg.openai_key)   document.getElementById('openai_key').value   = cfg.openai_key;
  if (cfg.openai_model) document.getElementById('openai_model').value = cfg.openai_model;
  if (cfg.ollama_url)   document.getElementById('ollama_url').value   = cfg.ollama_url;
  if (cfg.ollama_model) document.getElementById('ollama_model').value = cfg.ollama_model;
  refreshMUI();
  document.getElementById('backdrop').classList.add('on');
}
function closeSettings() { document.getElementById('backdrop').classList.remove('on'); }
function selModel(m) { selMdl = m; refreshMUI(); }
function refreshMUI() {
  ['local','claude','openai','ollama'].forEach(m => {
    document.getElementById('opt_'+m)?.classList.toggle('sel', m===selMdl);
    const r = document.getElementById('r_'+m);
    if (r) { r.classList.toggle('on', m===selMdl); }
    const i = document.getElementById('inp_'+m);
    if (i) i.style.display = m===selMdl && m!=='local' ? 'block' : 'none';
  });
}
function saveSettings() {
  const nc = {
    model:       selMdl,
    backend_url: document.getElementById('backend_url').value.trim().replace(/\/$/,''),
    claude_key:  document.getElementById('claude_key').value.trim(),
    openai_key:  document.getElementById('openai_key').value.trim(),
    openai_model:document.getElementById('openai_model').value,
    ollama_url:  document.getElementById('ollama_url').value.trim().replace(/\/$/,''),
    ollama_model:document.getElementById('ollama_model').value.trim(),
  };
  localStorage.setItem(CFGK, JSON.stringify(nc));
  cfg = nc;
  updateChip();
  closeSettings();
}
function updateChip() {
  const m = cfg.model||'local';
  const lbl = m==='claude'?'AI Analysis':m==='openai'?'AI Analysis Lite':m==='ollama'?'Private AI':'Instant';
  const dotCls = m==='ollama'?'dot or':m==='local'?'dot gr':'dot';
  document.getElementById('chipLabel').textContent = lbl;
  document.getElementById('modelDot').className = dotCls;
  document.getElementById('btnBadge').textContent = lbl;
  document.getElementById('aiBadge').textContent  = lbl;
}
updateChip();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALCULATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcIRR(f) {
  let r=0.08;
  for (let i=0;i<300;i++) {
    let n=0,d=0;
    for (let t=0;t<f.length;t++) { const p=Math.pow(1+r,t); n+=f[t]/p; d-=t*f[t]/((1+r)*p); }
    if (Math.abs(d)<1e-12) break;
    const rn=r-n/d;
    if (Math.abs(rn-r)<1e-9) return rn*100;
    r=rn;
  }
  return r*100;
}
function localCompute(p) {
  const grEst=p.purchase_price*p.transfer_tax_pct/100, notary=p.purchase_price*p.notary_pct/100;
  const closing=grEst+notary, loan=p.purchase_price+closing-p.equity, ltv=loan/p.purchase_price;
  const landV=p.purchase_price*p.land_share_pct/100, afaBasis=p.purchase_price+closing-landV;
  const afaRate=p.afa_rate_input??(p.condition==='newbuild'?0.03:0.02), annAfA=afaBasis*afaRate;
  const mRate=p.interest_rate/100/12, annMo=loan*(p.repayment_rate/100/12+mRate), annAnn=annMo*12;
  let rem=loan, cumCF=0;
  const yrs=[], iF={10:[-p.equity],15:[-p.equity],20:[-p.equity]};
  for (let yr=1;yr<=30;yr++) {
    const rg=p.rent_monthly*12*Math.pow(1+p.rent_growth/100,yr-1)*(1-p.vacancy_rate/100);
    const iy=rem*p.interest_rate/100, py=Math.min(annAnn-iy,rem);
    rem=Math.max(0,rem-py);
    const hAnn=p.hausgeld_monthly*12, ti=rg-iy-hAnn-annAfA, tax=ti*p.tax_rate/100;
    const nd=p.maintenance_nd+p.management_nd, aa=rem>0?annAnn:(iy+py);
    const cf=rg-aa-nd-tax; cumCF+=cf;
    const pv=p.purchase_price*Math.pow(1+p.appreciation/100,yr), nw=pv-rem;
    const em=(nw+cumCF)/p.equity;
    yrs.push({year:yr,rent_gross:rg,interest:iy,afa:annAfA,taxable_income:ti,tax_impact:tax,cash_flow:cf,property_value:pv,net_worth:nw,equity_multiple:em});
    const ex=pv-rem;
    [10,15,20].forEach(h=>{if(yr<h)iF[h].push(cf);else if(yr===h)iF[h].push(cf+ex);});
  }
  const ar=p.rent_monthly*12, gy=ar/p.purchase_price*100;
  const noi=ar*(1-p.vacancy_rate/100)-p.hausgeld_monthly*12-p.maintenance_nd, ny=noi/p.purchase_price*100;
  const kpf=p.purchase_price/ar, ts=Math.abs(Math.min(0,yrs[0].taxable_income*p.tax_rate/100));
  const i10=calcIRR(iF[10]),i15=calcIRR(iF[15]),i20=calcIRR(iF[20]);
  function sc(ny,kpf,irr,cfMo,ltv){let s=0;s+=ny>=4?2.5:ny>=3?1.5:ny>=2?.8:0;s+=kpf<18?2:kpf<22?1.5:kpf<28?1:.3;s+=irr>8?2.5:irr>6?2:irr>4?1.2:.3;s+=cfMo>0?1.5:cfMo>-200?.8:0;s+=ltv<.6?1.5:ltv<.7?1:ltv<.8?.5:0;return Math.round(Math.min(10,Math.max(0,s))*10)/10;}
  function vl(s){return s>=7.5?'Strong Buy':s>=6.5?'Buy':s>=5?'Hold / Review':s>=3.5?'Caution':'Avoid';}
  const score=sc(ny,kpf,i10,yrs[0].cash_flow/12,ltv);
  return {score,verdict:vl(score),purchase_price:p.purchase_price,equity:p.equity,loan:Math.round(loan),closing_costs:Math.round(closing),ltv_pct:ltv*100,afa_basis:Math.round(afaBasis),annual_afa:Math.round(annAfA),afa_rate_pct:afaRate*100,afa_tax_saving_yr1:Math.round(ts),annuity_monthly:Math.round(annMo),gross_yield_pct:gy,net_yield_pct:ny,kpf,irr_10:i10,irr_15:i15,irr_20:i20,equity_multiple_10:yrs[9]?.equity_multiple||0,equity_multiple_15:yrs[14]?.equity_multiple||0,equity_multiple_20:yrs[19]?.equity_multiple||0,cash_flow_monthly_yr1:yrs[0].cash_flow/12,year_data:yrs.filter(y=>[1,2,3,5,7,10,15,20].includes(y.year)),market_rent_m2:null,bodenrichtwert_m2:null,current_mortgage_rate:null,location_score:null,population_trend:null,ai_analysis:null,address_resolved:p.address};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI PROVIDERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SYS=`You are an expert German real estate investment analyst. Given property metrics, provide a concise professional analysis (under 250 words) covering: price fairness vs Bodenrichtwert, rental yield assessment, AfA tax advantage, key risks, and a clear Buy/Hold/Avoid recommendation with specific numbers.`;
function buildPrompt(m,p) {
  return `Property: ${p.address} | ${p.sqm}m¬≤ built ${p.year_built}
Price: ‚Ç¨${p.purchase_price.toLocaleString()} (‚Ç¨${Math.round(p.purchase_price/p.sqm).toLocaleString()}/m¬≤) | Equity: ‚Ç¨${p.equity.toLocaleString()} | LTV: ${m.ltv_pct.toFixed(1)}%
Net yield: ${m.net_yield_pct.toFixed(2)}% | Kaufpreisfaktor: ${m.kpf.toFixed(1)}√ó | Annuity: ‚Ç¨${m.annuity_monthly}/mo
Cash flow yr1: ${m.cash_flow_monthly_yr1>=0?'+':''}‚Ç¨${Math.round(m.cash_flow_monthly_yr1)}/mo after tax & debt
AfA: ${m.afa_rate_pct}% on ‚Ç¨${m.afa_basis.toLocaleString()} = ‚Ç¨${m.annual_afa.toLocaleString()}/yr ‚Üí tax saving ‚Ç¨${m.afa_tax_saving_yr1.toLocaleString()}/yr
IRR: ${m.irr_10.toFixed(1)}% (10yr) / ${m.irr_15.toFixed(1)}% (15yr) / ${m.irr_20.toFixed(1)}% (20yr)
Equity multiple: ${m.equity_multiple_10.toFixed(2)}√ó (10yr) / ${m.equity_multiple_20.toFixed(2)}√ó (20yr)
Market: Bodenrichtwert ‚Ç¨${m.bodenrichtwert_m2||'N/A'}/m¬≤ | Rent index ‚Ç¨${m.market_rent_m2||'N/A'}/m¬≤ | Rate ${m.current_mortgage_rate||'N/A'}% | Location ${m.location_score||'N/A'}/10
Score: ${m.score}/10 ‚Üí ${m.verdict}
Provide expert analysis and recommendation.`;
}
async function callClaude(m,p) {
  if (cfg.backend_url) {
    const res=await fetch(cfg.backend_url+'/analyse',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(collectForm())});
    if(!res.ok) throw new Error(`Backend ${res.status}`);
    const data=await res.json();
    Object.assign(m,{market_rent_m2:data.market_rent_m2,bodenrichtwert_m2:data.bodenrichtwert_m2,current_mortgage_rate:data.current_mortgage_rate,location_score:data.location_score,population_trend:data.population_trend,address_resolved:data.address_resolved});
    return data.ai_analysis;
  }
  const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':cfg.claude_key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-opus-4-6',max_tokens:900,system:SYS,messages:[{role:'user',content:buildPrompt(m,p)}]})});
  if(!res.ok){const e=await res.json();throw new Error(e.error?.message||`Analysis service ${res.status}`);}
  return (await res.json()).content[0].text;
}
async function callOpenAI(m,p) {
  const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.openai_key},body:JSON.stringify({model:(cfg.openai_model==='fast'?'gpt-4o-mini':cfg.openai_model==='legacy'?'gpt-4-turbo':cfg.openai_model&&cfg.openai_model!=='standard'?cfg.openai_model:'gpt-4o'),max_tokens:900,messages:[{role:'system',content:SYS},{role:'user',content:buildPrompt(m,p)}]})});
  if(!res.ok){const e=await res.json();throw new Error(e.error?.message||`Analysis service ${res.status}`);}
  return (await res.json()).choices[0].message.content;
}
async function callOllama(m,p) {
  const url=(cfg.ollama_url||'http://localhost:11434')+'/api/chat';
  const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:cfg.ollama_model||'private-analysis',stream:false,messages:[{role:'system',content:SYS},{role:'user',content:buildPrompt(m,p)}]})});
  if(!res.ok) throw new Error(`Private AI service error ${res.status}. Is your local service running?`);
  const d=await res.json();
  return d.message?.content||d.choices?.[0]?.message?.content||'No response from private AI service';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmt=(v,d=0)=>'‚Ç¨\u202f'+Math.abs(v).toLocaleString('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d});
const fP=(v,d=1)=>v.toFixed(d).replace('.',',')+'\u202f%';
const fX=(v,d=1)=>v.toFixed(d).replace('.',',')+'\u202f√ó';
const sT=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
function sM(id,val,cls=''){const e=document.getElementById(id);if(e){e.textContent=val;e.className='mv'+(cls?' '+cls:'');}}

function render(d,p) {
  // Score ring
  const arc=document.getElementById('scoreArc');
  const off=220-(d.score/10)*208, col=d.score>=7?'#34c759':d.score>=5?'#ff9500':'#ff3b30';
  if(arc) setTimeout(()=>{arc.style.strokeDashoffset=off;arc.style.stroke=col;},100);
  document.getElementById('scoreNum').innerHTML=d.score.toFixed(1).replace('.',',')+'<small>/10</small>';

  const vt=document.getElementById('verdictTitle');
  vt.textContent=d.verdict.toUpperCase();
  vt.className='vt '+(d.score>=7?'g':d.score>=5?'o':'r');
  const cfMo=d.cash_flow_monthly_yr1;
  sT('verdictSummary',`Net yield ${fP(d.net_yield_pct)} ¬∑ Kaufpreisfaktor ${fX(d.kpf)} ¬∑ IRR ${fP(d.irr_10)} (10yr) ¬∑ AfA ‚Ç¨${d.afa_tax_saving_yr1.toLocaleString('de-DE')}/yr tax saving ¬∑ CF ${cfMo>=0?'+':'‚àí'}‚Ç¨${Math.abs(Math.round(cfMo)).toLocaleString('de-DE')}/mo`);

  sM('mv_ny',  fP(d.net_yield_pct),  d.net_yield_pct>=3.2?'ok':d.net_yield_pct>=2?'mid':'bad');
  sM('mv_kpf', fX(d.kpf),            d.kpf<22?'ok':d.kpf<28?'mid':'bad');
  sM('mv_irr', fP(d.irr_10),         d.irr_10>6?'ok':d.irr_10>4?'mid':'bad');
  sM('mv_cf',  (cfMo>=0?'+':'‚àí')+'‚Ç¨'+Math.abs(Math.round(cfMo)).toLocaleString('de-DE'), cfMo>0?'ok':cfMo>-200?'mid':'bad');
  sM('mv_ltv', fP(d.ltv_pct),        d.ltv_pct<80?'ok':d.ltv_pct<90?'mid':'bad');
  sM('mv_afa', '‚Ç¨'+d.afa_tax_saving_yr1.toLocaleString('de-DE'));
  sT('mb_afa', `${fP(d.afa_rate_pct)} on ‚Ç¨${d.afa_basis.toLocaleString('de-DE')} basis`);
  sM('mv_ann', '‚Ç¨'+d.annuity_monthly.toLocaleString('de-DE')+'/mo');
  sM('mv_nk',  fmt(d.closing_costs));
  sT('mb_nk',  fP(d.closing_costs/d.purchase_price*100)+' of purchase price');

  // Bar chart
  const byrs=[1,5,10,15,20], cfs=byrs.map(yr=>d.year_data.find(y=>y.year===yr)?.cash_flow||0);
  const mx=Math.max(...cfs.map(Math.abs),1);
  document.getElementById('barChart').innerHTML=cfs.map((v,i)=>{
    const h=Math.max(Math.round(Math.abs(v)/mx*66),4);
    const l=(v>=0?'+':'‚àí')+'‚Ç¨'+(Math.abs(v)>=1000?(Math.abs(v)/1000).toFixed(1)+'k':Math.abs(v).toFixed(0));
    return `<div class="bc"><div class="bv">${l}</div><div class="bb ${v>=0?'p':'n'}" style="height:${h}px"></div><div class="byr">Yr${byrs[i]}</div></div>`;
  }).join('');

  // Flags
  const fl=[];
  fl.push([d.kpf<25?'ok':'warn',`Kaufpreisfaktor ${fX(d.kpf)} ‚Äî ${d.kpf<25?'fair value':'above 25√ó threshold'}`]);
  if(d.net_yield_pct>3.5) fl.push(['ok',`Net yield ${fP(d.net_yield_pct)} exceeds 3.5% target`]);
  else if(d.net_yield_pct>2.5) fl.push(['warn',`Net yield ${fP(d.net_yield_pct)} ‚Äî below 3.5% target`]);
  else fl.push(['bad',`Net yield ${fP(d.net_yield_pct)} ‚Äî significantly below market`]);
  fl.push([cfMo>=0?'ok':'warn',`Yr 1 cash flow: ${cfMo>=0?'+':'‚àí'}‚Ç¨${Math.abs(Math.round(cfMo)).toLocaleString('de-DE')}/mo after tax & debt service`]);
  fl.push([d.ltv_pct<=80?'ok':'bad',`LTV ${fP(d.ltv_pct)} ‚Äî ${d.ltv_pct<=80?'within bank limits':'exceeds 80% limit'}`]);
  fl.push(['info',`AfA ‚Ç¨${d.annual_afa.toLocaleString('de-DE')}/yr ‚Üí ‚Ç¨${d.afa_tax_saving_yr1.toLocaleString('de-DE')} tax saving yr 1`]);
  if(d.market_rent_m2&&p.sqm>0) fl.push([p.rent_monthly/p.sqm>d.market_rent_m2*1.1?'warn':'ok',`Rent ‚Ç¨${(p.rent_monthly/p.sqm).toFixed(1)}/m¬≤ vs market ‚Ç¨${d.market_rent_m2}/m¬≤`]);
  document.getElementById('flagsList').innerHTML=fl.map(([c,t])=>`<div class="fi"><div class="fd ${c==='info'?'info':c}"></div><span>${t}</span></div>`).join('');

  // IRR table
  document.getElementById('irrTable').innerHTML=[[10,d.irr_10,d.equity_multiple_10],[15,d.irr_15,d.equity_multiple_15],[20,d.irr_20,d.equity_multiple_20]].map(([yr,irr,em])=>{
    const g=((em-1)*100).toFixed(1);
    return `<tr${yr===parseInt(p.holding_years)?' class="hl"':''}><td>${yr} years</td><td class="${irr>5?'pos':'neg'}">${fP(irr)}</td><td>${em.toFixed(2).replace('.',',')}√ó</td><td class="${g>=0?'pos':'neg'}">${g>=0?'+':''}${g}%</td></tr>`;
  }).join('');

  // Detail table
  document.getElementById('detailTable').innerHTML=d.year_data.map(y=>`<tr><td>Yr ${y.year}</td><td>${fmt(y.rent_gross)}</td><td>${fmt(y.interest)}</td><td>${fmt(y.afa)}</td><td class="${y.tax_impact<=0?'pos':'neg'}">${y.tax_impact<=0?'+':'‚àí'}${fmt(Math.abs(y.tax_impact))}</td><td class="${y.cash_flow>=0?'pos':'neg'}">${y.cash_flow>=0?'+':'‚àí'}${fmt(Math.abs(y.cash_flow))}</td><td>${fmt(y.property_value)}</td></tr>`).join('');

  // AI tab
  sT('aiText', d.ai_analysis||'No analysis mode configured. Click ‚öô Settings to add your connection details.');
  sT('aiBadge', d._aiModel||'Instant');

  // Market tab
  const mi=[['Bodenrichtwert',d.bodenrichtwert_m2?`‚Ç¨${d.bodenrichtwert_m2}/m¬≤`:'N/A','Official land value'],['Rent Index',d.market_rent_m2?`‚Ç¨${d.market_rent_m2}/m¬≤`:'N/A','Mietspiegel'],['Mortgage Rate',d.current_mortgage_rate?`${d.current_mortgage_rate}%`:'N/A','Bundesbank 10yr'],['Location Score',d.location_score?`${d.location_score}/10`:'N/A','OSM amenity score'],['Population Trend',d.population_trend||'N/A','Annual growth'],['Address',d.address_resolved||p.address,'Geocoded']];
  document.getElementById('mktGrid').innerHTML=mi.map(([k,v,n])=>`<div class="mc2"><div class="mk">${k}</div><div class="mv2">${v}</div><div class="ms">${n}</div></div>`).join('');
  sT('mktBadge', d._dataSource||'Local');

  // AfA table
  const landV=p.purchase_price*p.land_share_pct/100;
  document.getElementById('afaBody').innerHTML=[
    ['Purchase price',fmt(d.purchase_price),''],
    ['Closing costs',fmt(d.closing_costs),`GrESt ${p.transfer_tax_pct}% + Notary ${p.notary_pct}%`],
    ['Land value (excl.)',fmt(landV),`${p.land_share_pct}% of purchase price`],
    ['AfA basis',fmt(d.afa_basis),'Price + Closing ‚àí Land'],
    ['AfA rate',fP(d.afa_rate_pct),d.afa_rate_pct===3?'¬ß7 EStG new build':'¬ß7 EStG existing building'],
    ['Annual AfA',fmt(d.annual_afa),'Deductible from rental income'],
    ['Tax rate',fP(p.tax_rate),'Marginal rate incl. Solidarit√§tszuschlag'],
    ['Tax saving yr1',fmt(d.afa_tax_saving_yr1),'If income negative (Werbungskosten√ºberschuss)'],
  ].map(([a,b,c])=>`<tr><td>${a}</td><td><strong style="font-family:'DM Mono',monospace">${b}</strong></td><td style="color:var(--t3)">${c}</td></tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sw(btn,id) {
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  document.querySelectorAll('.tpanel').forEach(p=>p.classList.remove('on'));
  document.getElementById('tp-'+id)?.classList.add('on');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectForm() {
  const afaRateEl=document.getElementById('f_afa_rate');
  const afaRateRaw=afaRateEl.value.trim();
  const afaRateInput=afaRateRaw===''?null:parseFloat(afaRateRaw);
  if(afaRateRaw!==''&&(Number.isNaN(afaRateInput)||afaRateInput<0||afaRateInput>0.07)) {
    throw new Error('AfA rate must be between 0 and 0.07, or left blank for the default rate.');
  }
  const v=document.querySelector('input[name="vac"]:checked');
  return {address:document.getElementById('f_address').value,sqm:parseFloat(document.getElementById('f_sqm').value)||0,year_built:parseInt(document.getElementById('f_yearbuilt').value)||1990,condition:document.getElementById('f_condition').value,purchase_price:parseFloat(document.getElementById('f_price').value)||0,equity:parseFloat(document.getElementById('f_equity').value)||0,interest_rate:parseFloat(document.getElementById('f_interest').value)||3.8,repayment_rate:parseFloat(document.getElementById('f_repayment').value)||2.0,transfer_tax_pct:parseFloat(document.getElementById('f_grunderwerb').value)||6.0,notary_pct:parseFloat(document.getElementById('f_notary').value)||2.0,agent_pct:0,land_share_pct:parseFloat(document.getElementById('f_landshare').value)||20,rent_monthly:parseFloat(document.getElementById('f_rent').value)||0,hausgeld_monthly:parseFloat(document.getElementById('f_hausgeld').value)||200,maintenance_nd:parseFloat(document.getElementById('f_maintenance').value)||1200,management_nd:parseFloat(document.getElementById('f_management').value)||600,rent_growth:parseFloat(document.getElementById('f_rentgrowth').value)||2.0,appreciation:parseFloat(document.getElementById('f_appreciation').value)||2.0,tax_rate:parseFloat(document.getElementById('f_taxrate').value)||44,vacancy_rate:v?parseFloat(v.id.replace('v','')):1,holding_years:parseInt(document.getElementById('f_horizon').value)||10,afa_method:document.getElementById('f_afa_method').value,afa_rate_input:afaRateInput};
}

const STEPS=['Computing closing costs‚Ä¶','Building AfA schedule‚Ä¶','Running amortisation table‚Ä¶','Calculating taxable income‚Ä¶','Computing IRR‚Ä¶','Calling AI model‚Ä¶'];

async function runAnalysis() {
  const ov=document.getElementById('loadingOverlay'), st=document.getElementById('lstep'), fi=document.getElementById('lfill');
  document.getElementById('emptyState').style.display='none';
  document.getElementById('resultsContent').style.display='none';
  ov.classList.add('on');
  fi.style.width='0';
  setTimeout(()=>fi.style.width='100%',50);
  let si=0;
  const iv=setInterval(()=>{
    if(si<STEPS.length){st.textContent=STEPS[si];const d=document.getElementById('ldots').children[si];if(d)d.classList.add('on');si++;}
  },500);
  try {
    const p=collectForm(); cfg=(() => { try { return JSON.parse(localStorage.getItem(CFGK))||{}; } catch { return {}; }})();
    const m=cfg.model||'local', result=localCompute(p);
    if(m!=='local') {
      result._aiModel=m==='claude'?'AI Analysis':m==='openai'?'AI Analysis Lite':'Private AI';
      result._dataSource=m==='claude'&&cfg.backend_url?'Live API':'Local calc + AI';
      try {
        if(m==='claude') result.ai_analysis=await callClaude(result,p);
        else if(m==='openai') result.ai_analysis=await callOpenAI(result,p);
        else if(m==='ollama') result.ai_analysis=await callOllama(result,p);
      } catch(e) { result.ai_analysis=`‚ö† AI failed: ${e.message}\n\nCalculations above are accurate.`; }
    }
    clearInterval(iv); ov.classList.remove('on');
    Array.from(document.getElementById('ldots').children).forEach(d=>d.classList.remove('on'));
    render(result,p);
    document.getElementById('resultsContent').style.display='block';
    document.querySelectorAll('.tab').forEach((b,i)=>b.classList.toggle('on',i===0));
    document.querySelectorAll('.tpanel').forEach((p,i)=>p.classList.toggle('on',i===0));
    document.getElementById('main').scrollTop=0;
  } catch(e) {
    clearInterval(iv); ov.classList.remove('on');
    alert('Error: '+e.message); console.error(e);
  }
}
</script>
</body>
</html>
